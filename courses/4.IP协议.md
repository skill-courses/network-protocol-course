# IP协议

![ip-internet-protocol](../images/ip-internet-protocol.jpeg)

IP协议是为计算机网络相互连接进行通信而设计的协议。在因特网中，它是能使连接到网上的所有计算机网络实现相互通信的一套规则，规定了计算机在因特网上进行通信时应当遵守的规则。任何厂家生产的计算机系统，只要遵守IP协议就可以与因特网互连互通。

IP协议实际上是一套由软件程序组成的协议软件，它把各种不同“帧”统一转换成“IP数据报”格式，这种转换是因特网的一个最重要的特点，使所有各种计算机都能在因特网上实现互通，即具有“开放性”的特点。正是因为有了IP协议，因特网才得以迅速发展成为世界上最大的、开放的计算机通信网络。因此，IP协议也可以叫做“因特网协议”。

IP协议位于TCP-IP网络模型的第三层，主要的作用如下：

* 定义网络层设备的逻辑地址，俗称网络层地址，如IP地址。
* 在不同的网段之间选择最佳转发路径。

## IP数据包

IP数据包是在IP层中用于在互联网上进行数据传输的数据单元，它包含了发送和接收主机之间传输的信息。其基本格式如下：

![ip-data-constructor](../images/ip-data-constructor.jpeg)

IP的数据包的长度是可变的，它由两部分组成：首部和数据。首部由两部分组成，固定部分和可变部分；固定部分为20个字节，可变部分由一些选项组成，最长40个字节。

### IP数据包各字段含义如下：
* 版本（Version）：指定IP协议版本号，IPv4为4，IPv6为6。
* 头部长度（Internet Header Length，IHL）：指定IP数据包头部长度，以32位字（4字节）为单位，最小值为5，最大值为15。
* 服务类型（Type of Service，TOS）：用于指定IP数据包的服务质量，包括优先级、延迟、吞吐量和可靠性等。
* 总长度（Total Length）：指定整个IP数据包的长度，包括头部和数据部分。
* 标识（Identification）：每个IP数据包都有一个唯一的标识符，用于将分片的数据包重新组合成完整的数据包。
* 标志（Flags）：用于标识是否为分片数据包，以及分片数据包的片段情况。
* 片段偏移（Fragment Offset）：指定分片数据包的偏移量，以8字节为单位。
* 存活时间（Time to Live，TTL）：用于限制IP数据包在互联网上传输的跳数，每经过一个路由器TTL值会减1，当TTL值为0时，数据包将被丢弃。
* 协议（Protocol）：指定IP数据包的上层协议类型，如TCP、UDP、ICMP等。
* 头部校验和（Header Checksum）：用于检验IP数据包头部的完整性，保证数据传输的可靠性。
* 源地址（Source Address）：指定发送方的IP地址。
* 目标地址（Destination Address）：指定接收方的IP地址。
* 选项（Options）：可选字段，用于扩展IP数据包的功能，如路由跟踪、时间戳等。
* 负载（Payload）：指定IP数据包的数据部分，即需要传输的具体数据。

### IP数据包封装流程 

IP数据包封装（Encapsulation）是指在数据传输过程中，将上层协议的数据添加IP头部和尾部，将其转换为IP数据包，以便在互联网上传输。

IP数据包封装的流程如下：
1. 应用层将需要传输的数据发送给传输层（如TCP或UDP），并将目标主机的IP地址和端口号一并传递给传输层。
2. 传输层将数据分段（如果需要），并将每个数据段添加传输层头部和尾部，生成传输层数据包。
3. 网络层（IP层）将传输层的数据包添加IP头部和尾部，生成IP数据包。
4. 网络接口层将IP数据包转换为二进制数据，加上网络接口头部和尾部，生成帧。
5. 帧通过物理层的介质传输到目标主机。
6. 目标主机的网络接口层接收到帧，将其转换为二进制数据，并去掉网络接口头部和尾部，生成IP数据包。
7. 目标主机的网际层接收到IP数据包，去掉IP头部和尾部，得到传输层数据包。
8. 目标主机的传输层接收到传输层数据包，去掉传输层头部和尾部，得到应用层的数据。

以上是IP数据包封装的基本流程，不同的协议和网络环境可能会有所不同。需要注意的是，IP数据包的封装过程是逐层封装的，每一层都添加了自己的头部和尾部，以便在传输过程中进行数据传递和路由。

需要特别注意的是，在整个过程中，IP地址始终保持不变，但是MAC地址在经过不同网段时，就会发生变化，而经过相同网段时，不会发生变化。